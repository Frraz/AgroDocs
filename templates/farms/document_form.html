{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-3">
  <div class="card">
    <div class="card-body">
      <h1 class="h5 mb-3">{{ form.instance.pk|yesno:"Editar documento,Novo documento" }}</h1>

      <form method="post" novalidate>
        {% csrf_token %}

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Fazenda</label>
            {{ form.farm }}
            {% if form.farm.errors %}<div class="text-danger small">{{ form.farm.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Nome</label>
            {{ form.nome }}
            {% if form.nome.errors %}<div class="text-danger small">{{ form.nome.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Tipo</label>
            {{ form.tipo }}
            {% if form.tipo.errors %}<div class="text-danger small">{{ form.tipo.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Emissão</label>
            {{ form.data_emissao }}
            {% if form.data_emissao.errors %}<div class="text-danger small">{{ form.data_emissao.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Vencimento</label>
            {{ form.data_vencimento }}
            {% if form.data_vencimento.errors %}<div class="text-danger small">{{ form.data_vencimento.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label d-flex align-items-center justify-content-between">
              <span>E-mail para notificar</span>
              <button class="btn btn-sm btn-outline-primary" type="button" id="btn-test-email">
                Testar e-mail
              </button>
            </label>
            {{ form.notify_email }}
            <div class="form-text">Enviaremos lembretes deste documento para este e-mail.</div>
            <div id="test-email-feedback" class="small mt-1"></div>
            {% if form.notify_email.errors %}<div class="text-danger small">{{ form.notify_email.errors }}</div>{% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label d-flex align-items-center justify-content-between">
              <span>WhatsApp para notificar</span>
              <button class="btn btn-sm btn-outline-success" type="button" id="btn-test-whatsapp">
                Testar WhatsApp
              </button>
            </label>
            {{ form.notify_whatsapp }}
            <div class="form-text">Use formato E.164 (ex.: +5511999999999).</div>
            <div id="test-whatsapp-feedback" class="small mt-1"></div>
            {% if form.notify_whatsapp.errors %}<div class="text-danger small">{{ form.notify_whatsapp.errors }}</div>{% endif %}
          </div>

          <div class="col-12">
            <label class="form-label">Lembretes</label>
            {{ form.lembretes }}
            {% if form.lembretes.errors %}<div class="text-danger small">{{ form.lembretes.errors }}</div>{% endif %}
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Salvar</button>
          <a class="btn btn-outline-secondary" href="{% url 'farms:document_list' %}">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// CSRF helper
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
}
const csrftoken = getCookie('csrftoken');

function setFeedback(el, msg, ok) {
  el.textContent = msg;
  el.classList.remove('text-danger', 'text-success');
  el.classList.add(ok ? 'text-success' : 'text-danger');
}

async function postJSON(url, data) {
  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
    body: JSON.stringify(data),
  });
  const js = await resp.json().catch(() => ({}));
  if (!resp.ok || js.ok === false) {
    throw new Error(js.error || `Erro HTTP ${resp.status}`);
  }
  return js;
}

document.getElementById('btn-test-email')?.addEventListener('click', async (e) => {
  const input = document.querySelector('[name="notify_email"]');
  const fb = document.getElementById('test-email-feedback');
  const btn = e.currentTarget;
  const value = (input?.value || '').trim();
  if (!value) return setFeedback(fb, 'Informe um e-mail para testar.', false);
  btn.disabled = true; setFeedback(fb, 'Enviando teste de e-mail...', true);
  try {
    const res = await postJSON("{% url 'farms:notification_test' %}", { channel: 'email', value });
    setFeedback(fb, `Teste enviado para ${res.sent_to}.`, true);
  } catch (err) {
    setFeedback(fb, err.message || 'Falha ao enviar teste de e-mail.', false);
  } finally {
    btn.disabled = false;
  }
});

document.getElementById('btn-test-whatsapp')?.addEventListener('click', async (e) => {
  const input = document.querySelector('[name="notify_whatsapp"]');
  const fb = document.getElementById('test-whatsapp-feedback');
  const btn = e.currentTarget;
  const value = (input?.value || '').trim();
  if (!value) return setFeedback(fb, 'Informe um número WhatsApp (E.164) para testar.', false);
  btn.disabled = true; setFeedback(fb, 'Enviando teste de WhatsApp...', true);
  try {
    const res = await postJSON("{% url 'farms:notification_test' %}", { channel: 'whatsapp', value });
    setFeedback(fb, `Teste enviado para ${res.sent_to}.`, true);
  } catch (err) {
    setFeedback(fb, err.message || 'Falha ao enviar teste de WhatsApp.', false);
  } finally {
    btn.disabled = false;
  }
});
</script>
{% endblock %}